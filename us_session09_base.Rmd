
# Settings {.sidebar}

<!-- ### Search criteria -->

###### Thank you for using the iTrack COVID App, US Edition. This App allows you to identify the regions in the USA that have the highest COVID-19 infection Spread and Growth, also known as Reproduction Rate or Rt. 

<!--uses advanced Data Science techniques . In order to do so, please choose the states where you want to search and the number of top search results  to be shown. -->

<!-- (removing all searches the entire country)  -->
<!-- where COVID-19 is sspreading the wors accelerating the most -->

<!-- In order to find the  -->
<!-- This App automatically searches and find the most contaminated areas in the USA on  `r format(Sys.time(), '%d %B, %Y') ` -->





```{r input daysToTrack showN}
  selectInput("state", 
            "Search state(s):",
            # width="100%",
            # "Step 1: Add / Remove State (sorted by longitude):",
            multiple=T, 
            selected = c( 'New York', "Vermont", "Maine", "New Hampshire", "Pennsylvania", 
                          "Washington", "Minnesota", "Montana", "North Dakota" ,"Wisconsin", "Ohio"), 
            # choices = dtData$state %>% unique %>% sort
            # selected = (dtData$state %>% unique)[1],
            
            # choices = dtGeo[country=="US"] [order(lng)]$state %>% unique 
            choices = dtGeo[country=="US" & lng <= dtGeo[state=="Guam"]$lng & state != STR_TOTAL] [order(lng)]$state %>% unique
)

sliderInput("showN", 
            label = "Find:",
            # width="100%",
            # label = "Step 2: Select the number of search results (0 to show all):",
            # pre = "top ",
            post  = " most infected",
            min = 0, max = 100, value = 40)



```
<!-- This database was last updated on `r dateMax`. -->

```{r r.dt, include=FALSE}
# .................................... ----



r.dt <- reactive({
  
  my.state="New York"
    my.state="Vermont"
  my.state=input$state 
  

  #     dt <- dtGeo [ dtData, on=c("country" , "state" , "city")]; dt
  #   dt <- dtGeo [ dtData [state %in% my.state], on=c("country" , "state" , "city")]; dt
  
  if (!is.null(my.state)) {
    # if (my.state != 'All States')
    dt <- dtGeo [ dtData [state %in% my.state], on=c("country" , "state" , "city")]; 
  } else {
    dt <- dtGeo [ dtData, on=c("country" , "state" , "city")]; 
  }
    
  dt[, region:=paste0( abbreviate(state, 2, T), ": ",  city)]
  
  
  showN = 6
  showN <- input$showN
  if ( showN > 0 )
    dt <- dt %>% covid.reduceToTopNCitiesToday(showN);dt 
  
  dt[, recovered:=NULL]
  
  if (T) {
    dt[, confirmedGrowth := round ( confirmed / shift(confirmed,1) , 3)] [ ] # aka  R0
    
    dt[, confirmedAcceleration := confirmed - shift(confirmed,1) ] [ ] # aka  R0
    dt[, confirmedPercentage:=round(confirmed/population*100,1)] []
    dt[, confirmedTotal := cumsum(confirmed)] []
    dt[, confirmedTotalPercentage := round(confirmedTotal/population*100,1)]

    dt[, deathsAcceleration := deaths - shift(deaths,1) ] [ ] # aka  R0
    dt[, deathsPercentage:=round(deaths/population*100,1)][]
    dt[, deathsTotal := cumsum(deaths)][]
    dt[, deathsTotalPercentage := round(deathsTotal/population*100,1)]
  } else {
    
    colsCases <- c("confirmed", "deaths")
    
    colsGrowth <- paste0(colsCases, "Growth")
    dt[ ,  (colsGrowth) := round ( .SD / shift(.SD, 1) , 3) , .SDcols = colsCases] [ ] 
    
    colsPercentage <- paste0(colsCases, "Percentage")
    colsTotal <- paste0(colsCases, "Total")
    colsTotalPercentage  <- paste0(colsCases, "TotalPercentage")
    

    dt[ ,  (colsPercentage) := lapply(.SD,  function(x) { round(x/population*100,1)  }   ), .SDcols = colsCases] []
    dt[ ,  (colsTotal) := cumsum(.SD), .SDcols = colsCases] []
    dt[ ,  (colsTotalPercentage) :=  lapply(.SD,  function(x) { round(x/population*100,1)  }   ), .SDcols = colsTotal] []
  }
  
  dt[, deathRate := round (deaths/confirmed*100,2)]
  dt[, deathRateAverage := round (deathsTotal/confirmedTotal*100,2)]
  
})

```


```{r radioButtons}

checkboxInput("log10", "Use Log scale", F)


sliderInput("daysToTrack", label = "Weeks to track:",
            width="100%",
            min = 1, max = 10, value=50)

checkboxInput("scale", "Keep the same scale", F)
# .................................... -------------

```


# Map and Table
<!-- # Today -->
<!-- # Search Criteria and Map -->

## .... Upper Row 750 {data-height=600 .tabset .tabset-fade }
<!-- ## Column name not printed {data-width=1000} -->

### Map

```{r}

renderLeaflet({
  
  dtToday <- r.dt()[date==dateMax] 
  plotMap(dtToday,input)
  
  # dtToday[, ratingcol:= ifelse(confirmedGrowth<1, "yellow", "red")]
  # 
  # dtToday[, strMessage:= paste0(state, " - ", city, 
  #                               ":<br><b>Confirmed</b>",
  #                               "<br>  Total: ", confirmedTotal, "(", confirmedTotalPercentage, "%)",
  #                               "<br>  Daily: ", confirmed, "(", confirmedPercentage, "% population)", 
  #                               "<br> <b>Deaths</b>",
  #                               "<br>  Total: ", deathsTotal, "(", deathsTotalPercentage, "%)",
  #                               "<br>  Daily: ", deaths, "(", deathsPercentage, "% population)",
  #                               "<br><b>Death rate </b>", 
  #                               "<br>  Today: ", deathRate, ". Average: ", deathRateAverage, 
  #                               "<br>  Rt = ", confirmedGrowth 
  # )  ]
  # 
  # leaflet::leaflet(dtToday) %>% 
  #   addTiles() %>%
  #   addCircleMarkers(~lng, ~lat, 
  #                    color = ~ratingcol, 
  #                    popup = ~strMessage,
  #                    label = ~paste0(region, ": ", confirmed, "(", confirmedPercentage, "%) / day. R0=", confirmedGrowth) 
  #   ) %>% 
  #   addPopups(~lng,  ~lat, 
  #             popup = ~paste0(city, ": ", confirmed, " / day. Rt=", confirmedGrowth) 
  #   )  %>%
  #   addLegend("bottomleft",
  #             colors = c("yellow","red"),
  #             labels = c(
  #               "Growth (Rt) < 1",
  #               "Growth (Rt) > 1"),
  #             opacity = 0.7)
  
})
```



## .... Upper Row 250 {data-height=400 .tabset .tabset-fade }


### Table 


<!-- ### Table  {data-height=1000} -->

```{r}
DT::renderDataTable({
  
  r.dt() [date==dateMax]%>% 
    DT::datatable(
      # filter ="top",
      options = list(
        scrollY = TRUE,
        scrollX = TRUE)
    )
})
```


### for printing
```{r}

renderPrint({
  
  r.dt() [date==dateMax] %>% 
    knitr::kable()
})

```
<!-- > Legend: ... -->

### for pasting
<!-- ###  Alternative view -->

```{r}

renderTable({
  r.dt() [date==dateMax]
  })
# .................................... -------------

```




<!-- #  Situation today (`r format(Sys.time(), '%d %B, %Y')`) -->
# Growth and Spread
<!-- # Dynamics today -->
<!-- # Today -->

<!-- #### Plot settings: -->
<!-- ```{r} -->
<!-- checkboxInput("log10", "Use Log scale", F) -->
<!-- ``` -->

## .... Upper Row {.tabset .tabset-fade }



### Growth Rate (Rt)


```{r}

r.gTodayR <- reactive({
  dt <- r.dt()

  g <- dt[date==dateMax] %>%
    ggplot(
      # aes(x=region)
      aes(x=
            # region,
            reorder(region, confirmedGrowth),
          # reorder(region, get(input$sortby))
          # reorder(region, ifelse(input$ascending, 1, -1)*get(input$sortby)),
      )
    )  +
    theme_bw() +
    # facet_wrap(state~.) +

    coord_flip() + 

    geom_point(aes(y=confirmedGrowth, size=confirmed, col=deathRate ), alpha=0.8) +
    scale_color_distiller(palette = "Oranges") + 
        scale_fill_distiller(palette = "Reds", direction = 1) +   #scale_fill_grey(0.3, 0.9) +

    # guides(col="none") +

    theme(legend.position = "bottom") +
    labs(
      title= paste0("Growth Rate (Rt) on ", dateMax),
      # size="Total number of cases",
      # fill="Mortality rate ",
      # # y="Infected (orange) and deaths (red) per day. \nChange since yesterday is marked by arrow.",
      y="Rt",
      # x=NULL

      caption=caption.covid
    )


  if (input$log10 ) {
    g <- g + scale_y_log10()
  }

  g
})

renderPlot( {
  print( r.gTodayR() )
})

```

> The plot shows the top results, sorted by the growth rate. Change in the number of infected cases since yesterday is marked by arrow.


### Spread (New and Total Cases)

<!-- ### New Cases -->


```{r}

r.gToday <- reactive({
  dt <- r.dt()

  g <- dt[date==dateMax] %>%
    ggplot(
      # aes(x=region)
      aes(x=
                        # reorder(region, confirmedGrowth),
            reorder(region, confirmed),
            # region,
            # reorder(region, get(input$sortby))
          # reorder(region, ifelse(input$ascending, 1, -1)*get(input$sortby)),
      )
    )  +
    theme_bw() +
    # facet_grid(reorder(region, region)~.) +

    coord_flip() + 


    
    geom_col(aes(y=confirmed,fill=confirmedGrowth, width=confirmedTotal/max(confirmedTotal)), alpha=1) +
    scale_fill_gradient2(low = "yellow", high="red", mid="orange", midpoint = 1) +   #scale_fill_grey(0.3, 0.9) +
    # guides(fill="none") +

    
    # geom_col(aes(y=confirmed), fill="blue", alpha=0.7) +
    # geom_col(aes(y=confirmed, fill=confirmedGrowth)) +
    # geom_point(aes(y=confirmed-confirmedAcceleration, size=confirmedTotal), data = dt[date==dateMax-1], alpha=0.4, col="orange") +
    # geom_point(aes(y=confirmed, size=confirmedTotal ), data = dt[date==dateMax-1], alpha=0.4, col="orange") +
    geom_point(aes(y=confirmed-confirmedAcceleration, size=confirmedTotal), alpha=0.4,  col="orange") + 
    geom_point(aes(y=confirmed, size=confirmedTotal ), alpha=0.99, col="orange") +

        
    geom_col(aes(y=deaths), alpha=0.99) +
    geom_point(aes(y=deaths,size=confirmedTotal, col= deathRate), alpha=0.9) +
    scale_color_distiller(palette = "Blues", direction = 1) +
        # scale_fill_distiller(palette = "Reds", direction = 1) +   #scale_fill_grey(0.3, 0.9) +

    geom_segment( aes( xend=region,
                       yend=confirmed, y=confirmed-confirmedAcceleration      ),
                  size = 1, col="black",
                  arrow = arrow(length = unit(0.1, "cm"))
    ) +

    # guides(col="none") +

    # theme(legend.position = "bottom") +
    labs(
      title= paste0("New cases of infected and deaths on ", dateMax),
      size="Total number of cases",
      col="Mortality rate (%)",
      fill="Growth rate (Rt) ",
      # y="Infected (orange) and deaths (red) per day. \nChange since yesterday is marked by arrow.",
      y=NULL,
      x=NULL

      # caption=caption.covid
    )


  if (input$log10 ) {
    g <- g + scale_y_log10()
  }

  g
})

renderPlot( {
  print( r.gToday() )
})
# .................................... -------------


```

> The plot shows the top results, sorted by the growth rate. Change in the number of infected cases since yesterday is marked by arrow.



<!-- ###  Interactive  -->
<!-- <!-- ###Explore search results --> -->

<!-- ```{r} -->

<!-- renderPlotly( { -->
<!--   ggplotly(r.gToday()) -->
<!-- }) -->


<!-- ``` -->

<!-- > The plot shows the top results, sorted by the selected criteria. Change in the number of infected cases since yesterday is marked by arrow. -->




<!-- ###  Interactive  -->
<!-- <!-- ###Explore search results --> -->

<!-- ```{r} -->

<!-- renderPlotly( { -->
<!--   ggplotly(r.gTodayR()) -->
<!-- }) -->


<!-- ``` -->

<!-- > The plot shows the top results, sorted by the selected criteria. Change in the number of infected cases since yesterday is marked by arrow. -->



# Trends

<!-- ## This caption is not printed {.tabset .tabset-fade } -->
## Dynamic trends and models {data-height=940}

<!-- ### Pandemic spread analysis -->
### Dynamics over time

```{r fig.width=12, fig.height=9, fig.align='center'}


r.gTrend <- reactive({
  g <- r.dt() [ date > dateMax - 7*input$daysToTrack] %>% 

    ggplot() + 

    facet_wrap( . ~  region,
                scales=ifelse(input$scale, "fixed", "free")) +  
    geom_line(aes(date, confirmed), col="orange") +
    labs(
      title= paste0("Infected per day"),
      subtitle=paste0("State: ", input$state, ". Date: ", dateMax, " (Cities are sorted by the number of infected)"),  
      caption=paste0( 
        "Data source: Johns Hopkins University U.S. Coronavirus database\n",
        "Generated by R Ottawa"
      )
    )
  
  if (input$log10 ) {
    g <- g + scale_y_log10()
  }
  
  
})

renderPlot( {
  print( r.gTrend() )
})
# .................................... -------------


```

<!-- ### Interactive plot -->

<!-- ```{r} -->
<!-- renderPlotly( { -->
<!--   ggplotly( r.gTrend() ) -->
<!-- }) -->

<!-- ``` -->

<!-- # Detailed Results -->
<!-- # Table -->

<!-- ## Dynamic metrics to show {data-height=60} -->

